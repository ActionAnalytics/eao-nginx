server {
	listen       8080;
	server_name  _;

	# Allows non-standard headers like SMGOV_USERGUID
	ignore_invalid_headers off;

	# 172.16.0.0/12 is the entire addressable space in the cluster
	#set_real_ip_from  172.51.0.0/22;
	#set_real_ip_from  172.51.4.0/22;
	#real_ip_header    X-Forwarded-For;

	location /parse {
		# proxy all traffic to this URL,
		# note the trailing slash strips out the /proxy path on
		# the request to the upstream server

		proxy_pass ${NGINX_PROXY_PARSE};

		# Ensure HTTP get passed thru
		proxy_pass_request_headers on;

		# its helpful to cache these responses
		proxy_cache globalcache;
	}

	location /parse-dashboard/ {
		# proxy all traffic to this URL,
		# note the trailing slash strips out the /proxy path on
		# the request to the upstream server

		proxy_pass ${NGINX_PROXY_PARSE};

		# Ensure HTTP get passed thru
		proxy_pass_request_headers on;

		# its helpful to cache these responses
		proxy_cache globalcache;
	}

	location / {
		# proxy all traffic to this URL,
		# note the trailing slash strips out the /proxy path on
		# the request to the upstream server

		proxy_pass ${NGINX_PROXY_URL};

		# Ensure HTTP get passed thru
		proxy_pass_request_headers on;

		# its helpful to cache these responses
		proxy_cache globalcache;

		# Deploy-time configurable
		${HTTP_BASIC}

		# Enable CORS for other domains
		if ($http_origin ~ '^https?://(localhost|.*\.pathfinder\.gov\.bc\.ca)') {
			add_header 'Access-Control-Allow-Origin' "$http_origin" always;
			add_header 'Access-Control-Allow-Credentials' 'true' always;
			add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
			add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
			# required to be able to read Authorization header in frontend
			#add_header 'Access-Control-Expose-Headers' 'Authorization' always;
		}

		if ($request_method = 'OPTIONS') {
			# Tell client that this pre-flight info is valid for 20 days
			add_header 'Access-Control-Max-Age' 1728000;
			add_header 'Content-Type' 'text/plain charset=UTF-8';
			add_header 'Content-Length' 0;
			return 204;
		}
	}

	# Cache the lib directory
	location /lib {
		proxy_pass ${NGINX_PROXY_URL};
		proxy_cache   globalcache;
	}

	# For status of ngnix service
	location /nginx_status {
		# Enable Nginx stats
		stub_status on;
		# Only allow access from localhost
		allow 127.0.0.1;
		# Other request should be denied
		deny all;
		# No need to log this request, its just noise
		access_log off;
	}
}
